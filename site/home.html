<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>zhufucdev</title>
    <link rel="stylesheet" href="/shared/materialize.css">
    <link rel="stylesheet" href="/shared/material-icons.css">
    <link rel="stylesheet" href="/shared/style.css">
    <script src="/shared/jquery-3.4.1.js"></script>
    <script src="/shared/materialize.js"></script>
    <script src="/shared/repeater.js"></script>
    <script src="/shared/splash.js"></script>
    <script src="/shared/utility.js"></script>
    <script src="/shared/cookies.js"></script>
</head>
<body>
<main>
    <div class="navbar-fixed">
        <nav>
            <div class="nav-wrapper">
                <a class="brand-logo">zhufucdev</a>
                <a class="hide-on-large-only left sidenav-trigger" style="margin-left: 12px" data-target="main-sidenav"
                   href="#"><i class="material-icons">menu</i></a>
            </div>
        </nav>
    </div>
    <div style="width: 100%; display: none" class="deep-orange row" id="browser-not-supported">
        <span class="white-text col">您的浏览器似乎并不支持ECMAScript 2015或自定义标签的特性，故无法显示某些内容</span>
        <i class="material-icons white-text col right waves-effect" onclick="$(this).parent().hide()">close</i>
    </div>
    <ul class="sidenav sidenav-fixed" id="main-sidenav">
        <li>
            <div class="user-view">
                <div class="background blue"></div>
                <a><img src="shared/face.png" class="circle"></a>
                <a><span class="white-text name">zhufucdev</span> </a>
                <a><span class="white-text email">A individual developer for Java and C#</span> </a>
            </div>
        </li>
        <li><a class="selected-item waves-effect"><i class="material-icons">build</i>项目</a></li>
        <li><a class="waves-effect" href="about"><i class="material-icons">error</i>关于</a></li>
    </ul>
    <div class="container">
        <div class="center progress-bar">
            <div class="preloader-wrapper small active">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-yellow">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-green">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="center red-text" style="display: none" id="error-display">
            <i class="material-icons big">error</i>
            <h4>发生了一些错误</h4>
        </div>
        <div class="repeater"></div>
    </div>
</main>
</body>
<script>
    if (!checkBrowser()) {
        $('#browser-not-supported').show()
    }
    if (typeof docCookies === "object" && !docCookies.hasItem('splash')) {
        document.body.insertAdjacentElement('afterbegin', document.createElement('splash-screen'));
        docCookies.setItem('splash', 'shown', new Date(new Date().getFullYear() + 10, 1));
    }
    let progress = document.querySelector('.progress-bar');
    let repeaterEle = document.querySelector('.repeater');
    let errorDis = document.querySelector('#error-display');

    function hideProgress() {
        repeaterEle.style.opacity = '0';
        fadeOut(progress, () => {
            progress.style.display = 'none';
            fadeIn(repeaterEle)
        });
    }

    function showError(err) {
        function insert() {
            errorDis.insertAdjacentHTML('beforeend', '<p>' + err + '</p>');
        }

        if (errorDis.style.display === 'none')
            fadeOut(progress, () => {
                progress.style.display = 'none';
                insert();
                fadeIn(errorDis)
            });
        else
            insert();
    }
    animateTitle("项目");
    let repeater;
    try {
        repeater = Repeat.init(repeaterEle);
        $(repeater.contentElement).addClass('row');
        repeater.model = `
<div class="col s12 m6">
    <div class="card">
        <div class="card-image"><img src="/shared/project-icons/%name.png"></div>
        <div class="card-stacked">
            <div class="card-content">
                <span class="card-title">%name</span>
                <p>%subtitle</p>
            </div>
            <div class="card-action">%lang</div>
        </div>
    </div>
</div>
    `;
    } catch (e) {
        showError('无法初始化Repeater: ' + e)
    }

    $.ajax({
        url: '/shared/projects.json',
        dataType: 'json',
        success: (r) => {
            try {
                repeater.beginUpdate();
                r.forEach(project => {
                    function langByCode(code) {
                        let language;

                        function getIcon() {
                            return '<img src="/shared/project-icons/languages/' + code + '.png" height="12px"/>'
                        }

                        switch (code) {
                            case "kt":
                                language = "Kotlin";
                                break;
                            case "js":
                                language = "JavaScript";
                                break;
                            case "java":
                                language = "Java";
                                break;
                            case "html":
                                language = "HTML";
                                break;
                            case "css":
                                language = "CSS";
                                break;
                            case "cs":
                                language = 'C#';
                                break;
                            default:
                                if (typeof code === "string") {
                                    code[0] = code[0].toUpperCase();
                                    language = code;
                                }
                                break;
                        }
                        return getIcon() + language;
                    }

                    let languages = "";
                    if (typeof project.lang === "string") {
                        languages = langByCode(project.lang);
                    } else {
                        for (let i in project.lang) {
                            let code = project.lang[i];
                            languages += langByCode(code);
                            if (i !== project.lang.length - 1) languages += ", "
                        }
                    }
                    project.lang = languages;
                    hideProgress();
                    repeater.push(project, project.category);
                });
                repeater.endUpdate();
            } catch (e) {
                showError('无法加载数据：' + e)
            }
        },
        error: function (e) {
            showError('服务器返回了无效数据: ' + e.status)
        }
    });
    try {
        M.AutoInit();
    } catch (e) {
        showError('无法初始化UI组件：' + e)
    }
</script>
</html>